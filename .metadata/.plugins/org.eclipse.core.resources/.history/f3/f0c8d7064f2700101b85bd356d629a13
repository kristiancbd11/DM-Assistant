package control;

import dbhandlerCRUD.NacionCRUD;
import dbhandlerCRUD.PersonajeCRUD;
import javafx.event.ActionEvent;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javafx.scene.control.Button;
import javafx.stage.Stage;
import views.CreationPersonajeView;
import clases_personaje.Personaje;
import clases_personaje.Raza;
import clases_personaje.Religion;
import clases_partida.Mundo;
import clases_partida.Nacion;
import clases_partida.O_Nacion;
import clases_roles.Clase;
import clases_personaje.Ideologia;

import java.util.List;

public class CreationPersonajeController {
    private CreationPersonajeView view;
    private PersonajeCRUD personajeCrud;
    private NacionCRUD nacionCrud;
    private ExplorerController explorerController;
    private Mundo mundo;
    private boolean npc;

    public CreationPersonajeController(CreationPersonajeView view, ExplorerController explorerController, Mundo mundo, boolean npc) {
        this.view = view;
        this.personajeCrud = new PersonajeCRUD();
        this.nacionCrud = new NacionCRUD();
        this.explorerController = explorerController;
        this.mundo = mundo;
        this.npc = npc;
        
        // Inicializar eventos de los botones
        initialize();
    }

    private void initialize() {
        // Crear el personaje al presionar el botón "Crear"
        view.getBtnCrear().setOnAction(this::crearPersonaje);

        // Cancelar la operación y cerrar la vista al presionar el botón "Cancelar"
        view.getBtnCancelar().setOnAction(this::cancelarCreacion);
    }

    private void crearPersonaje(ActionEvent event) {
        // Obtener los datos del formulario
        String nombre = view.getNombreField().getText().trim();
        String sexo = view.getSexoField().getText().trim();
        int edad = view.getEdadSpinner().getValue();
        Raza raza = view.getRazaCombo().getValue();
        Religion religion = view.getReligionCombo().getValue();
        O_Nacion onacion = view.getNacionCombo().getValue();
        Nacion nacion = nacionCrud.fetchNacion(onacion.getIdNacion());
        Clase clase = view.getClaseCombo().getValue();
        List<Ideologia> ideologias = view.getIdeologiaList().getSelectionModel().getSelectedItems();

        // Validación de los campos
        if (nombre.isEmpty() || sexo.isEmpty() || raza == null || religion == null || nacion == null || clase == null || ideologias.isEmpty()) {
            showAlert(AlertType.WARNING, "Formulario incompleto", "Por favor, completa todos los campos.");
            return;
        }

        // Crear el personaje con los datos proporcionados
        if(npc) {
        	Personaje personaje = new Personaje(nombre, raza, sexo, religion, nacion, ideologias, edad, clase);
            
        } else {
        	Personaje personaje = new Personaje(nombre, raza, sexo, religion, nacion, ideologias, edad, clase);
            mundo.addPersonaje(personaje);
        }
        
        // Guardar el personaje
        boolean personajeGuardado = personajeCrud.savePersonaje(personaje);
        explorerController.refreshTreeView();

        // Mostrar alertas según el resultado
        if (personajeGuardado) {
            showAlert(AlertType.INFORMATION, "Personaje Creado", "El personaje ha sido creado correctamente.");
        } else {
            showAlert(AlertType.ERROR, "Error al crear personaje", "Hubo un error al crear el personaje. Intenta de nuevo.");
        }
    }

    private void cancelarCreacion(ActionEvent event) {
        // Cerrar la vista actual (ventana de creación)
        Stage stage = (Stage) view.getScene().getWindow();
        stage.close();
    }

    private void showAlert(AlertType alertType, String header, String content) {
        Alert alert = new Alert(alertType);
        alert.setHeaderText(header);
        alert.setContentText(content);
        alert.showAndWait();
    }
}
